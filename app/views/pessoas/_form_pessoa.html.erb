<script>
    $(function () {
        $('#tem_facebook_<%= tipo_pessoa %>').on('change', function () {
            if ($(this).prop('checked')) {
                $('#campos_de_facebook_<%= tipo_pessoa %>').show();
                carregarImagem<%= tipo_pessoa %>();

                if ($('#esta_tirando_facebook_<%= tipo_pessoa %>').size() > 0) {
                    $('#esta_tirando_facebook_<%= tipo_pessoa %>').val("0");
                }
            }
            else {
                $('#campos_de_facebook_<%= tipo_pessoa %>').hide();
                carregarImagem<%= tipo_pessoa %>('<%= Pessoa.url_imagem_sem_imagem(120) %>');

                if ($('#esta_tirando_facebook_<%= tipo_pessoa %>').size() > 0) {
                    $('#esta_tirando_facebook_<%= tipo_pessoa %>').val("1");
                }
            }
        });

        $('#nome_facebook_<%= tipo_pessoa %>').on('keyup', function () {
            var nome_facebook = $(this).val().trim();

            if ($('#nome_<%= tipo_pessoa %>').data('acompanhar') == '1') {
                $('#nome_<%= tipo_pessoa %>').val(nome_facebook);
            }

            if ($('#nome_usual_<%= tipo_pessoa %>').data('acompanhar') == '1') {
                var primeiro_nome = nome_facebook.split(" ")[0];

                $('#nome_usual_<%= tipo_pessoa %>').val(primeiro_nome);
            }
        });

        $('#nome_<%= tipo_pessoa %>').on('keyup', function () {
            if ($(this).val() == "") {
                $(this).data('acompanhar', '1');
            }
            else {
                $(this).data('acompanhar', '0');
            }
        });

        $('#nome_usual_<%= tipo_pessoa %>').on('keyup', function () {
            if ($(this).val() == "") {
                $(this).data('acompanhar', '1');
            }
            else {
                $(this).data('acompanhar', '0');
            }
        });

        $('#imagem_facebook_<%= tipo_pessoa %>').on('blur', function () {
            carregarImagem<%= tipo_pessoa %>();
        });

        $('#carregar_imagem_<%= tipo_pessoa %>').on('click', function (evento) {
            evento.preventDefault();
            carregarImagem<%= tipo_pessoa %>();
        });

        $('#novo_telefone_<%= tipo_pessoa %>').on('click', function (evento) {
            evento.preventDefault();
            $('#telefones_<%= tipo_pessoa %>').append(
                            '<div class="campos_telefone">'
                                + '<div class="field">'
                                    + '<label for="telefone_<%= tipo_pessoa %>">Número</label><br/>'
                                    + '<input type="text" name="telefones_<%= tipo_pessoa %>[]" class="mascara_telefone" size="30" />'
                                + '</div>'
                                + '<div class="field">'
                                    + '<label for="telefone_<%= tipo_pessoa %>">Operadora</label><br/>'
                                    + '<%= select_tag "operadoras_#{tipo_pessoa}[]", (raw options_for_select(operadoras_telefone).gsub! "\n", "") %> '
                                    + '<a href="#" class="link_remover remover_telefone_<%= tipo_pessoa %>">Remover telefone</a>'
                                + '</div>'
                            + '</div>'
            );

            atualizarLinksPraRemoverTelefoneEMascara<%= tipo_pessoa %>();
        });

        atualizarLinksPraRemoverTelefoneEMascara<%= tipo_pessoa %>();

    });

    function carregarImagem<%= tipo_pessoa %>(url) {
        if (url == null && $('#imagem_facebook_<%= tipo_pessoa %>').val() != "") {
            $('#imagem_<%= tipo_pessoa %>').attr('src', $('#imagem_facebook_<%= tipo_pessoa %>').val());
        }
        else {
            $('#imagem_<%= tipo_pessoa %>').attr('src', url);
        }
    }

    function atualizarLinksPraRemoverTelefoneEMascara<%= tipo_pessoa %>() {
        $('.remover_telefone_<%= tipo_pessoa %>').on('click', function (evento) {
            evento.preventDefault();

            $(this).closest('.campos_telefone').remove();
        });

        $('.mascara_telefone').mask(
            '(00) 0000-0000',
            {
                clearIfNotMatch: true,
                placeholder: '(__) ____-____'
            }
        );
    }
</script>

<table border="0">
  <tr>
    <td class="imagem_form">
      <img src="<%= pessoa.url_imagem(120) %>" id="imagem_<%= tipo_pessoa %>" class="imagem_pessoa_form"/>
    </td>
    <td>
      <% if pode_editar_facebook_de_pessoa(pessoa) %>
          <% if pessoa.tem_informacoes_facebook %>
              <input type="hidden" id="esta_tirando_facebook_<%= tipo_pessoa %>" value="0" />
          <% end %>


          <label class="label_tem_facebook">
            <input type="checkbox" id="tem_facebook_<%= tipo_pessoa %>" name="tem_facebook_<%= tipo_pessoa %>"
                <% if pessoa.tem_facebook || pessoa.url_facebook.present? %>
                    checked="checked"
                <% end %>
            />Tem Facebook
          </label>

          <div class="campos_de_facebook" id="campos_de_facebook_<%= tipo_pessoa %>"
            <% if !pessoa.tem_facebook && !pessoa.url_facebook.present? %>
                style="display: none;"
            <% end %>
          >
            <div class="field">
              <label for="nome_facebook_<%= tipo_pessoa %>">
                Nome no Facebook (IMPORTANTE: O nome deve ser <u>exatamente</u> como está no Facebook para que o usuário tenha acesso)
              </label><br>
              <span class="erro_form"><%= pessoa.errors[:nome_facebook].first %></span>
              <input type="text" name="nome_facebook_<%= tipo_pessoa %>" id="nome_facebook_<%= tipo_pessoa %>" style="width: 400px;" value="<%= pessoa.nome_facebook %>" />
            </div>

            <div class="field">
              <%= label_tag "link_facebook_#{tipo_pessoa}", 'Link para Facebook' %><br>
              <span class="erro_form"><%= pessoa.errors[:url_facebook].first %></span>
              <input type="text" name="url_facebook_<%= tipo_pessoa %>" id="url_facebook_<%= tipo_pessoa %>" style="width: 400px;" value="<%= pessoa.url_facebook %>" />
            </div>

            <div class="field">
              <%= label_tag "imagem_facebook_#{tipo_pessoa}", 'Link para imagem do Facebook' %><br>
              <span class="erro_form"><%= pessoa.errors[:url_foto_grande].first %></span>
              <input type="text" name="imagem_facebook_<%= tipo_pessoa %>" id="imagem_facebook_<%= tipo_pessoa %>" style="width: 400px;" value="<%= pessoa.url_foto_grande %>" />
              <a href="#" class="link_procurar_fb" id="carregar_imagem_<%= tipo_pessoa %>">Carregar</a>
            </div>
          </div>
      <% else %>
        <%
            if pessoa.tem_informacoes_facebook
                valor_tem_facebook = 'on'
        %>
              <input type="hidden" name="nome_facebook_<%= tipo_pessoa %>" value="<%= pessoa.nome_facebook %>" />
              <input type="hidden" name="url_facebook_<%= tipo_pessoa %>" value="<%= pessoa.url_facebook %>" />
              <input type="hidden" name="imagem_facebook_<%= tipo_pessoa %>" value="<%= pessoa.url_foto_grande %>" />
        <%
            else
                valor_tem_facebook = 'off'
            end
        %>
        <input type="hidden" name="tem_facebook_<%= tipo_pessoa %>" value="<%= valor_tem_facebook %>" />
      <% end %>

      <%
         acompanhar = pessoa.nome.present? ? '0' : '1'
      %>

      <div class="field">
        <%= label_tag "nome_#{tipo_pessoa}", 'Nome*' %><br>
        <div class="erro_form"><%= pessoa.errors[:nome].first %></div>
        <input type="text" name="nome_<%= tipo_pessoa %>" id="nome_<%= tipo_pessoa %>" value="<%= pessoa.nome %>" size="40" data-acompanhar="<%= acompanhar %>" />
      </div>

      <div class="field">
        <%= label_tag "nome_usual_#{tipo_pessoa}", 'Nome usual*' %><br>
        <div class="erro_form"><%= pessoa.errors[:nome_usual].first %></div>
        <input type="text" name="nome_usual_<%= tipo_pessoa %>" id="nome_usual_<%= tipo_pessoa %>" value="<%= pessoa.nome_usual %>" size="40" data-acompanhar="<%= acompanhar %>" />
      </div>

      <div class="field">
        <%= label_tag 'Gênero' %><br>

        <label><%= radio_button_tag "eh_homem_#{tipo_pessoa}", true, pessoa.eh_homem, :id => "eh_homem_#{tipo_pessoa}" %> Homem</label>
        <label><%= radio_button_tag "eh_homem_#{tipo_pessoa}", false, !pessoa.eh_homem, :id => "eh_mulher_#{tipo_pessoa}" %> Mulher</label>
      </div>

      <div class="field">
        <%= label_tag "dia_#{tipo_pessoa}", 'Data de nascimento' %><br/>
        <div class="erro_form"><%= pessoa.errors[:nascimento].first %></div>

        <%= select_tag "dia_#{tipo_pessoa}", options_for_select(1..31, pessoa.dia), :include_blank => true %>
        <%= select_tag "mes_#{tipo_pessoa}", options_for_select(1..12, pessoa.mes), :include_blank => true %>
        <%= select_tag "ano_#{tipo_pessoa}", options_for_select(Date.today.year.downto(1920).to_a, pessoa.ano), :include_blank => true %>
      </div>

      <div class="field">
        <%= label_tag "email_#{tipo_pessoa}", 'Email' %><br/>
        <div class="erro_form"><%= pessoa.errors[:email].first %></div>
        <%= text_field_tag "email_#{tipo_pessoa}", pessoa.email, size: 30 %>
      </div>

      <br style="clear: right;" />

      <div class="field">
        <%= label_tag 'Telefones' %><br/>

        <span id="telefones_<%= tipo_pessoa %>">
            <%
               telefones = pessoa.telefones
               telefones.each do |telefone|
            %>
                <div class="campos_telefone">
                    <div class="field">
                        <label for="telefone_<%= tipo_pessoa %>">Número</label><br/>
                        <div class="erro_form"><%= telefone.errors[:telefone].first %></div>
                        <input type="text" name="telefones_<%= tipo_pessoa %>[]" value="<%= telefone.telefone %>" class="mascara_telefone" size="30" />
                    </div>
                    <div class="field">
                        <label for="telefone_<%= tipo_pessoa %>">Operadora</label><br/>
                        <div class="erro_form"><%= telefone.errors[:operadora].first %></div>
                        <%= select_tag "operadoras_#{tipo_pessoa}[]", options_for_select(operadoras_telefone, telefone.operadora) %>
                        <a href="#" class="link_remover remover_telefone_<%= tipo_pessoa %>">Remover telefone</a>
                    </div>
                </div>
            <% end %>
        </span>

        <a href="#" id="novo_telefone_<%= tipo_pessoa %>" class="link_novo">Adicionar telefone</a>
      </div>

      <br style="clear: right;" />

      <% if tipo_pessoa != 'conjuge' %>

          <div class="field">
            <%= label_tag "rua_#{tipo_pessoa}", 'Rua' %><br>
            <div class="erro_form"><%= pessoa.errors[:rua].first %></div>
            <%= text_field_tag "rua_#{tipo_pessoa}", pessoa.rua, size: 20 %>
          </div>

          <div class="field">
            <%= label_tag :"numero_#{tipo_pessoa}", 'Número' %><br>
            <div class="erro_form"><%= pessoa.errors[:numero].first %></div>
            <%= text_field_tag "numero_#{tipo_pessoa}", pessoa.numero, size: 3 %>
          </div>

          <div class="field">
            <%= label_tag :"complemento_#{tipo_pessoa}", 'Complemento' %><br>
            <div class="erro_form"><%= pessoa.errors[:complemento].first %></div>
            <%= text_field_tag "complemento_#{tipo_pessoa}", pessoa.complemento, size: 10 %>
          </div>

          <div class="field">
            <%= label_tag "bairro_#{tipo_pessoa}", 'Bairro' %><br>
            <div class="erro_form"><%= pessoa.errors[:bairro].first %></div>
            <%= text_field_tag "bairro_#{tipo_pessoa}", pessoa.bairro, size: 15 %>
          </div>

          <div class="field">
            <%= label_tag "cidade_#{tipo_pessoa}", 'Cidade' %><br>
            <div class="erro_form"><%= pessoa.errors[:cidade].first %></div>
            <%= text_field_tag "cidade_#{tipo_pessoa}", pessoa.cidade %>
          </div>

          <div class="field">
            <%= label_tag "estado_#{tipo_pessoa}", 'Estado' %><br>
            <div class="erro_form"><%= pessoa.errors[:estado].first %></div>
            <%= select_tag "estado_#{tipo_pessoa}", options_for_select(estados_brasil, pessoa.estado), :include_blank => true %>
          </div>

          <div class="field">
            <%= label_tag "cep_#{tipo_pessoa}", 'CEP' %><br>
            <div class="erro_form"><%= pessoa.errors[:cep].first %></div>

            <%
               cep1 = ''
               cep2 = ''
               if pessoa.cep.present?
                 elementos = pessoa.cep.split('-')
                 cep1 = elementos[0]
                 cep2 = elementos[1]
               end
            %>

            <%= text_field_tag "cep1_#{tipo_pessoa}", cep1, size: 5, maxlength: 5 %>-<%= text_field_tag "cep2_#{tipo_pessoa}", cep2, size: 3, maxlength: 3 %>
          </div>
      <% end %>
    </td>
  </tr>
</table>