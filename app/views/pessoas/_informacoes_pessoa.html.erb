<script>
  function preencherConjuntos(elemento, json, denominacao) {
      $(elemento).empty();
      $.each(json, function (index, conjunto) {
          var nomeAExibir = '';

          if (conjunto.tipo == 'Equipe') {
              nomeAExibir += 'Equipe ';
          }
          else {
              nomeAExibir += denominacao + ' ';
          }

          nomeAExibir += conjunto.nome

          elemento.append('<option value="' + conjunto.id + '">' + nomeAExibir + '</option>');
      });
  }

  $(function () {
      $('.link_adicionar_a_grupo').on('click', function (evento) {
          evento.preventDefault();
          $(this).siblings('.adicionar_a_grupo').show();
          $(this).hide();
      });

      $('.link_cancelar_adicionar_a_grupo').on('click', function (evento) {
          evento.preventDefault();

          var div = $(this).closest('.adicionar_a_grupo');

          $(div).hide();
          $(div).siblings('.link_adicionar_a_grupo').show();
      });

      $('.link_adicionar_participacao').on('click', function (evento) {
          evento.preventDefault();
          $(this).siblings('.adicionar_participacao').show();
          $(this).hide();
      });

      $('.link_cancelar_adicionar_participacao').on('click', function (evento) {
          evento.preventDefault();

          var div = $(this).closest('.adicionar_participacao');

          $(div).hide();
          $(div).siblings('.link_adicionar_participacao').show();
      });

      $('.grupo_participacao').on('change', function (evento) {
          var pessoaId = $(this).closest('.adicionar_participacao').find(".pessoa-id").val();
          var denominacao = $(this).closest('.adicionar_participacao').find(".denominacao").val();
          var selectEncontro = $(this).closest('.adicionar_participacao').find('.encontro_participacao');
          var selectConjunto = $(this).closest('.adicionar_participacao').find('.conjunto_participacao');
          var denominacoesEncontros = $('#denominacoes_encontros');

          $.get(
                  "<%= encontros_de_grupo_url %>",
                  {
                      id: $(this).val()
                  },
                  function (resposta) {
                      $(selectEncontro).empty();
                      $(selectConjunto).empty();
                      $(denominacoesEncontros).empty();

                      $.each(resposta, function (index, encontro) {
                          selectEncontro.append('<option value="' + encontro.id + '">' + encontro.nome + ' (' + encontro.data_inicio.substring(0, 4) + ')</option>');
                          denominacoesEncontros.append('<input id="denominacao_' + encontro.id + '" type="hidden" value="' + encontro.denominacao_conjuntos_permanentes + '" />');
                          if (index == 0) {
                              $.get(
                                      "<%= conjuntos_para_adicionar_pessoa_url %>",
                                      {
                                          pessoa_id: pessoaId,
                                          encontro_id: encontro.id
                                      },
                                      function (respostaConjuntos) {
                                          preencherConjuntos(selectConjunto, respostaConjuntos, encontro.denominacao_conjuntos_permanentes);
                                      }
                              );
                          }
                      });
                  }
          );
      });

      $('.encontro_participacao').on('change', function (evento) {
          var pessoaId = $(this).closest('.adicionar_participacao').find(".pessoa-id").val();
          var selectConjunto = $(this).closest('.adicionar_participacao').find('.conjunto_participacao');
          var encontroId = $(this).val();
          var denominacao = $('#denominacao_' + encontroId).val();

          $.get(
                  "<%= conjuntos_para_adicionar_pessoa_url %>",
                  {
                      pessoa_id: pessoaId,
                      encontro_id: encontroId
                  },
                  function (respostaConjuntos) {
                      preencherConjuntos(selectConjunto, respostaConjuntos, denominacao);
                  }
          );
      });

      $('.link_submeter_adicionar_a_grupo').on('click', function (evento) {
          evento.preventDefault();

          var grupoEscolhido = $(this).closest('.adicionar_a_grupo').find('.grupo_a_adicionar').val();

          if (grupoEscolhido == null || grupoEscolhido == '') {
              $("#dialog_conteudo").html('Não foi selecionado <em>nenhum grupo</em> no qual adicionar a pessoa.');
              $("#dialog_conteudo").append("<p/><a href='#' class='dialog_link_confirmar'>OK</a>");
              $("#dialog").show();

              $(".dialog_link_confirmar").on("click", function (evento) {
                  evento.preventDefault();
                  esconderDialog();
              });
          }
          else {
              $(this).closest('form').submit();
          }
      });

      $('.link_submeter_adicionar_participacao').on('click', function (evento) {
          evento.preventDefault();

          var conjuntoEscolhido = $(this).closest('.adicionar_participacao').find('.conjunto_participacao').val();

          if (conjuntoEscolhido == null || conjuntoEscolhido == '') {
              $("#dialog_conteudo").html('Não foi selecionada <em>nenhuma participação</em> na qual adicionar a pessoa.');
              $("#dialog_conteudo").append("<p/><a href='#' class='dialog_link_confirmar'>OK</a>");
              $("#dialog").show();

              $(".dialog_link_confirmar").on("click", function (evento) {
                  evento.preventDefault();
                  esconderDialog();
              });
          }
          else {
              $(this).closest('form').submit();
          }
      });
      
  });
</script>

<table class="informacoes_pessoa <%= "conjuge_50_50" if tem_conjuge && !tem_auto_sugestoes %>">
  <tr>
    <td>
        <img src="<%= pessoa.url_imagem(200) %>" class="imagem_facebook_detalhe"/>
    </td>
    <td>
        <b>Nome completo:</b> <%= pessoa.nome %><br/>
        <b>Nome usual:</b> <%= pessoa.nome_usual %><br/>
        <b>Facebook:</b> <%= link_to "Facebook", pessoa.url_facebook, target: '_blank', class: 'link_facebook' unless pessoa.url_facebook.blank? %><br/>
        <b>Gênero:</b> <%= (pessoa.eh_homem? ? "Homem" : "Mulher") %><br/>
        <b>Data de nascimento:</b> <%= pessoa.nascimento.strftime("%d/%m/%Y") unless pessoa.nascimento.blank? %><br/>
        <b>Email:</b> <%= link_to pessoa.email, "mailto:#{pessoa.email}", target: '_blank' unless pessoa.email.blank? %><br/>
        <b>Endereço:</b> <%= pessoa.endereco %><br/>

        <%
            if pessoa.telefones.count > 1
                titulo_telefones = "Telefones"
                separador_telefones = "<br/>"
                array_telefones = []
                pessoa.telefones.each do |telefone|
                    array_telefones << "#{telefone.telefone} (#{telefone.operadora})"
                end
                string_telefones = array_telefones.join("<br/>")
            else
                titulo_telefones = "Telefone"
                separador_telefones = " "
                if pessoa.telefones.count == 1
                    telefone = pessoa.telefones.first
                    string_telefones = "#{telefone.telefone} (#{telefone.operadora})"
                else
                    string_telefones = ""
                end
            end
        %>

        <b><%= titulo_telefones %>:</b><%= raw separador_telefones %><%= raw string_telefones %><br/>

        <b>Habilidades musicais:</b> <%= pessoa.instrumentos.collect{|instrumento| instrumento.nome}.join(", ") %><br/>

        <% if pessoa.ultimo_login.present? %>
            <p><b>Último login:</b> <%= pessoa.ultimo_login.strftime('%d/%m/%Y às %H:%M:%S') %></p>
        <% end %>

        <% if @usuario_logado.grupos_em_que_pode_adicionar_outra_pessoa(pessoa).count + pessoa.grupos.count > 0 &&
                pessoa.auto_inserido == false %>
            <h2 class="sem_espaco_embaixo">Grupos</h2>
            <% if pessoa.participacoes_em_grupos.count > 0 %>
                <ul class="bullets">
                    <% pessoa.participacoes_em_grupos.each do |participacao| %>
                      <li><span>
                        <% coordenador = participacao[:grupo].coordenadores.include?(pessoa) ? ' (Coord.)' : '' %>

                        <% if pode_gerenciar_grupo participacao[:grupo] %>
                            <%= link_to "#{participacao[:grupo].nome}#{coordenador}", participacao[:grupo] %>
                        <% else %>
                            <%= "#{participacao[:grupo].nome}#{coordenador}" %>
                        <% end %>

                        <% if !participacao[:ativo] %>
                            (ex-participante)
                        <% end %>
                      </span></li>
                    <% end %>
                </ul>
            <% end %>
            <% if @usuario_logado.grupos_em_que_pode_adicionar_outra_pessoa(pessoa).count > 0 %>
                <%= link_to 'Adicionar a um grupo', '#', class: 'link_novo link_adicionar_a_grupo' %>

                <%= form_tag adicionar_pessoa_a_grupo_url, class: 'adicionar_a_grupo', style: 'display: none; margin-top: 10px; position: relative;' do %>
                  <input type="hidden" name="id_pessoa" value="<%= pessoa.id %>"/>
                  <div class="field">
                    <label for="id_grupo">Grupo</label><br/>
                    <%= select_tag 'id_grupo', options_for_select(@usuario_logado.grupos_em_que_pode_adicionar_outra_pessoa(pessoa).collect{|g| [g.nome, g.id]}), include_blank: false, class: 'grupo_a_adicionar' %>
                  </div><br/>
                  <a href="#" class="link_submeter_adicionar_a_grupo link_submeter" style="margin-right: 10px">Adicionar</a>
                  <a href="#" class="link_cancelar_adicionar_a_grupo link_remover">Cancelar</a>
                <% end %>
            <% end %>
        <% end %>

        <% if (@usuario_logado.eh_super_admin? ||
                @usuario_logado.encontros_que_esta_coordenando_agora.count > 0 ||
                @usuario_logado.grupos_que_tem_encontros_que_coordena.count > 0 ||
                participacoes.count > 0) &&
                pessoa.auto_inserido == false %>
            <h2 class="sem_espaco_embaixo">Participações em encontros</h2>
            <% if participacoes.count > 0 %>
                <ul class="bullets">
                    <% participacoes.each do |conjunto| %>
                      <% texto_encontro_participacao = "#{conjunto.encontro.nome} (#{conjunto.encontro.data_inicio.year})" %>

                      <% cor = conjunto.cor.present? ? conjunto.cor.hex_cor : nil %>

                      <li <% if cor.present? %>style="color: <%= cor %>;"<% end %>><span>
                        <% if pode_ver_encontro(conjunto.encontro) %>
                            <%= link_to texto_encontro_participacao, encontro_path(conjunto.encontro) %>
                        <% else %>
                            <%= texto_encontro_participacao %>
                        <% end %>

                        -

                        <% coordenador = conjunto.coordenadores.include?(pessoa) ? ' (Coord.)' : '' %>

                        <%
                          if conjunto.tipo == 'Equipe'
                            texto_conjunto_participacao = "Equipe #{conjunto.nome}#{coordenador}"
                            link_conjunto_participacao = equipe_path(conjunto)
                          elsif conjunto.tipo == 'CoordenacaoEncontro'
                            texto_conjunto_participacao = "Coordenação do Encontro"
                            link_conjunto_participacao = encontro_editar_coordenadores_path(conjunto.encontro)
                          else
                            texto_conjunto_participacao = "#{conjunto.tipo_do_conjunto} #{conjunto.nome}#{coordenador}"
                            link_conjunto_participacao = circulo_path(conjunto)
                          end
                        %>    
                        <% if pode_ver_conjunto(conjunto) %>                        
                          <%= link_to texto_conjunto_participacao, link_conjunto_participacao %>
                        <% else %>
                          <%= texto_conjunto_participacao %>
                        <% end %>
                      </span></li>
                    <% end %>
                </ul>
            <% end %>

            <% 
              encontros_que_esta_coordenando_agora = @usuario_logado.encontros_que_esta_coordenando_agora
              grupos_que_tem_encontros_que_coordena = @usuario_logado.grupos_que_tem_encontros_que_coordena
            %>

            <% if @usuario_logado.eh_super_admin? ||
                    encontros_que_esta_coordenando_agora.count > 0 ||
                    grupos_que_tem_encontros_que_coordena.count > 0 %>
                <%
                  if @usuario_logado.eh_super_admin?
                    grupos = Grupo.where(tem_encontros: true)
                  elsif encontros_que_esta_coordenando_agora.count > 0
                    grupos = encontros_que_esta_coordenando_agora.collect{|e| e.grupo}
                  elsif grupos_que_tem_encontros_que_coordena.count > 0
                    grupos = grupos_que_tem_encontros_que_coordena
                  end

                  primeiro_grupo = grupos.first

                  if primeiro_grupo
                    if @usuario_logado.eh_super_admin? || grupos_que_tem_encontros_que_coordena.count > 0
                      encontros = primeiro_grupo.encontros
                    elsif encontros_que_esta_coordenando_agora.count > 0
                      encontros = @usuario_logado.encontros_que_esta_coordenando_agora.select{|e| e.grupo == primeiro_grupo}
                    end
                    primeiro_encontro = encontros.first
                  else
                    encontros = []
                    primeiro_encontro = nil
                  end

                  if primeiro_encontro
                    conjuntos = primeiro_encontro.conjuntos_que_poderia_adicionar_pessoa(pessoa)
                  else
                    conjuntos = []
                  end
                %>

                <%= link_to 'Adicionar participação', '#', class: 'link_novo link_adicionar_participacao' %>

                <%= form_tag adicionar_pessoa_a_conjunto_url, class: 'adicionar_participacao', style: 'display: none; margin-top: 10px;' do %>
                    <input type="hidden" name="id_pessoa" class="pessoa-id" value="<%= pessoa.id %>"/>

                    <div class="field">
                        <label for="grupo">Grupo</label><br/>
                        <%= select_tag 'grupo', options_for_select(grupos.collect{|g| [g.nome, g.id]}), include_blank: false, class: 'grupo_participacao' %>
                    </div>

                    <div class="field">
                        <label for="grupo">Encontro</label><br/>
                        <%= select_tag 'encontro', options_for_select(encontros.collect{|e| ["#{e.nome} (#{e.data_inicio.year})", e.id]}), include_black: false, class: 'encontro_participacao' %>
                        <div style="display: none;" id="denominacoes_encontros">
                            <% encontros.each do |encontro| %>
                                <input id="denominacao_<%= encontro.id %>" type="hidden" value="<%= encontro.denominacao_conjuntos_permanentes %>" />
                            <% end %>
                        </div>
                    </div>
                    <br/>

                    <div class="field">
                        <label for="grupo">Participação</label><br/>
                        <%= select_tag 'id_conjunto', options_for_select(conjuntos.collect{|c| ["#{c.tipo_do_conjunto} #{c.nome}", c.id]}), include_black: false, class: 'conjunto_participacao' %>
                    </div>
                    <br/>

                    <div class="field">
                      <label><input type="checkbox" name="eh_coordenador" value="true" /> Coordenador</label>
                    </div>

                    <br/>
                    <a href="#" class="link_submeter_adicionar_participacao link_submeter" style="margin-right: 10px">Adicionar</a>
                    <a href="#" class="link_cancelar_adicionar_participacao link_remover">Cancelar</a>
                <% end %>
            <% end %>
        <% end %>

        <% auto_sugestoes = @usuario_logado.auto_sugestoes_de_outra_pessoa(pessoa.id) %>

        <% if auto_sugestoes.count > 0 %>

            <h2 class="sem_espaco_embaixo">
              Participações 
              <% if tem_conjuge %>
                individuais (não dos dois como casal)
              <% end %>
              pendendo confirmação
            </h2>
          
            <%= render 'confirmar_ou_rejeitar_auto_sugestoes', auto_sugestoes: auto_sugestoes, nome: pessoa.nome, auto_inserido: pessoa.auto_inserido %>

        <% end %>
    </td>
  </tr>
</table>